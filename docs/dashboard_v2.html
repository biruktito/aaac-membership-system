<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AAAC Dashboard v2 (Firestore)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f8fafc; color:#0f172a; }
    header { padding: 16px; background:#0ea5e9; color:white; }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 12px 0; }
    .card { background:white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 14px; }
    .row { display:flex; gap: 10px; align-items:center; }
    .list { display:grid; gap:8px; margin-top: 16px; }
    .member { background:white; border:1px solid #e2e8f0; border-radius:8px; padding:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size: 12px; }
    .badge.current{ background:#dcfce7; color:#166534; }
    .badge.behind{ background:#fee2e2; color:#991b1b; }
    .muted { color:#475569; font-size: 13px; }
    button { background:#0ea5e9; color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#e2e8f0; color:#0f172a; }
    .warn { color:#b91c1c; }
    .green { color:#166534; }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <!-- Inline config fallback to avoid Pages loading issues -->
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyDa4rimRWUUgPp7LAAaZzyrn13MKM-9naA",
      authDomain: "aaac-membership-1221.firebaseapp.com",
      projectId: "aaac-membership-1221",
      storageBucket: "aaac-membership-1221.firebasestorage.app",
      messagingSenderId: "134230731518",
      appId: "1:134230731518:web:2eb24bfa5cb9e9df2453af",
      measurementId: "G-YJJD19WXBG",
    };
  </script>
  <script src="firebase-init.js"></script>
</head>
<body>
  <header>
    <div class="row" style="justify-content: space-between;">
      <div>
        <div style="font-weight:700; font-size:18px;">AAAC Membership System — v2 (Firestore)</div>
        <div class="muted">Real-time, single source of truth. September 2025 calculations.</div>
      </div>
      <div class="row">
        <button id="btnSignInEmail" class="secondary">Sign in (Email)</button>
        <button id="btnSignIn" class="secondary">Sign in Anonymously</button>
        <button id="btnSignOut" class="secondary" style="display:none;">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <div class="cards">
      <div class="card"><div>Total Members</div><div id="statTotal" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Current</div><div id="statCurrent" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Behind</div><div id="statBehind" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Owed by Active</div><div id="statOwed" style="font-size:24px; font-weight:700;">—</div></div>
    </div>

    <div class="row" style="gap:8px;">
      <input id="search" placeholder="Search members by name..." style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px;" />
      <select id="filterStatus" style="padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
        <option value="all">All</option>
        <option value="current">Current</option>
        <option value="behind">Behind</option>
        <option value="issue">Issue</option>
        <option value="risk">Risk</option>
        <option value="inactive">Inactive</option>
      </select>
      <button id="refresh">Recalculate</button>
    </div>

    <div id="list" class="list"></div>
  </main>

  <!-- Record Payment Modal -->
  <div id="paymentModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:10px; width:100%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,0.15);">
      <div style="font-weight:700; font-size:16px;">Record Payment</div>
      <div id="pmember" class="muted" style="margin:6px 0 12px;"></div>
      <div style="display:flex; gap:8px;">
        <input id="pamount" type="number" min="0" step="0.01" placeholder="$ Amount" style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px;" />
        <select id="ptype" style="padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
          <option value="monthly">Monthly Dues</option>
          <option value="incidental">Incidental</option>
          <option value="registration">Registration</option>
        </select>
      </div>
      <div id="ppreview" class="muted" style="margin-top:8px; font-size:13px;"></div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="psave">Save</button>
        <button id="pcancel" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const CURRENT_DATE = new Date('2025-09-01T00:00:00Z');
    const DUE_PER_MONTH = 15; // USD
    const USE_LOCAL_ONLY = false; // Firestore is the single source of truth for v2

    function monthKey(date) { return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}`; }

    function calculateMemberFinancials(member) {
      // Accept both Firestore map and local JSON paymentsDues
      const payments = member.payments || member.paymentsDues || {};
      // Baseline cutoff: ALWAYS start at Jan 2022
      const start = new Date('2022-01-01T00:00:00Z');
      const iter = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), 1));
      const end = new Date(Date.UTC(CURRENT_DATE.getUTCFullYear(), CURRENT_DATE.getUTCMonth(), 1));
      let totalOwed = 0; let totalPaid = 0; let monthsBehind = 0; let paidUpTo = null;
      let inConsecutiveCoverage = true; // stops updating paidUpTo after first unpaid gap

      while (iter <= end) {
        const key = monthKey(iter);
        const paid = Number(payments[key] || 0);
        totalPaid += paid;
        totalOwed += DUE_PER_MONTH;
        const isCovered = paid >= DUE_PER_MONTH;
        if (inConsecutiveCoverage && isCovered) {
          paidUpTo = new Date(iter);
        } else if (!isCovered) {
          monthsBehind += 1;
          inConsecutiveCoverage = false;
        }
        iter.setUTCMonth(iter.getUTCMonth() + 1);
      }

      const balance = totalPaid - totalOwed; // negative means owes
      let status = 'current';
      if (!member.isActive) status = 'inactive';
      else if (balance < 0) {
        if (monthsBehind >= 6) status = 'risk';
        else if (monthsBehind >= 3) status = 'issue';
        else status = 'behind';
      } else if (balance > 0) {
        status = 'ahead';
      }

      return { balance, monthsBehind, paidUpTo, status, totalOwed, totalPaid };
    }

    function renderStats(members) {
      let total = members.length;
      let current = 0; let behind = 0; let owed = 0;

      // Active definition: any payment in the last 36 months
      const isActiveDerived = (m) => {
        const payments = m.payments || m.paymentsDues || {};
        const keys = Object.keys(payments);
        if (!keys.length) return false;
        const threshold = new Date('2022-10-01T00:00:00Z'); // 36 months before 2025-09 is 2022-10
        return keys.some(k => {
          const [y, mm] = k.split('-');
          const d = new Date(`${y}-${mm}-01T00:00:00Z`);
          return payments[k] > 0 && d >= threshold;
        });
      };
      members.forEach(m => {
        const f = calculateMemberFinancials(m);
        if (isActiveDerived(m)) {
          if (f.balance < 0) owed += Math.abs(f.balance);
          if (f.balance >= 0) current += 1; else behind += 1;
        }
      });
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statCurrent').textContent = current;
      document.getElementById('statBehind').textContent = behind;
      document.getElementById('statOwed').textContent = `$${owed.toFixed(2)}`;
    }

    function formatPaidUpTo(date) {
      if (!date) return 'Not Started';
      return date.toLocaleString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
    }

    function renderList(members) {
      const q = document.getElementById('search').value.trim().toLowerCase();
      const f = document.getElementById('filterStatus').value;
      const container = document.getElementById('list');
      container.innerHTML = '';
      members
        .filter(m => !q || (m.fullName || '').toLowerCase().includes(q))
        .slice(0, 250)
        .forEach(m => {
          const f = calculateMemberFinancials(m);
          if (document.getElementById('filterStatus').value !== 'all' && f.status !== document.getElementById('filterStatus').value) return;
          const div = document.createElement('div');
          div.className = 'member';
          const statusClass = (f.status === 'current' || f.status === 'ahead') ? 'current' : 'behind';
          const balanceEl = f.balance < 0 ? `<span class="warn">-$${Math.abs(f.balance).toFixed(2)}</span>` : `<span class="green">$${f.balance.toFixed(2)}</span>`;
          // Admin actions (visible when signed-in email user)
          const role = window.__role || 'member';
          const isAdmin = role === 'admin';
          const isBoard = role === 'board';
          const actions = (isAdmin || isBoard) ? `
            <div class="row" style="gap:8px; margin-top:8px;">
              ${isAdmin ? `<button data-action="record" data-id="${m.id}">Record Payment</button>` : ''}
              <button class="secondary" data-action="remind" data-id="${m.id}">Generate Reminder</button>
            </div>
          ` : '';
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:600;">${m.fullName || 'Unnamed'}</div>
                <div class="muted">Member ID: ${m.memberId || '—'}</div>
              </div>
              <span class="badge ${statusClass}">${f.status}</span>
            </div>
            <div class="muted" style="margin-top:6px;">Balance: ${balanceEl} • Months behind: ${f.monthsBehind} • Paid up to: ${formatPaidUpTo(f.paidUpTo)}</div>
            ${actions}
          `;
          container.appendChild(div);
        });

      // Wire admin buttons
      container.querySelectorAll('button[data-action="record"]').forEach(btn => {
        btn.onclick = () => openPaymentModal(btn.getAttribute('data-id'));
      });
      container.querySelectorAll('button[data-action="remind"]').forEach(btn => {
        btn.onclick = () => generateReminder(btn.getAttribute('data-id'));
      });
    }

    async function loadLocalJsonMembers() {
      const res = await fetch('cleaned_members_final.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load local JSON');
      const raw = await res.json();
      return raw.map(m => ({
        id: String(m.memberId || m.id || ''),
        memberId: m.memberId,
        fullName: m.fullName || m.name,
        isActive: m.isActive,
        startDate: (m.startDate || '') + (m.startDate && m.startDate.length === 7 ? '-01' : ''),
        payments: m.payments || m.paymentsDues || {}
      }));
    }

    function attachRealtime() {
      const { db } = window.firebaseServices || {};
      if (!db) {
        alert('Firebase not initialized. Create docs/firebase-config.js from the example and reload.');
        return () => {};
      }

      return db.collection('members').onSnapshot(async (snap) => {
        let members = [];
        snap.forEach(doc => members.push({ id: doc.id, ...doc.data() }));

        // If Firestore has no docs OR no payments across all docs, fallback to local JSON
        const totalPayments = members.reduce((sum, m) => {
          const p = m.payments || {};
          return sum + Object.values(p).reduce((s, v) => s + Number(v || 0), 0);
        }, 0);
        const needsFallback = (!members.length) || (totalPayments === 0);
        if (needsFallback) {
          try {
            const res = await fetch('cleaned_members_final.json', { cache: 'no-store' });
            if (res.ok) {
              const raw = await res.json();
              // Transform JSON schema -> v2 schema
              members = raw.map(m => {
                const payments = m.payments || m.paymentsDues || {};
                return {
                  id: String(m.memberId || m.id || ''),
                  memberId: m.memberId,
                  fullName: m.fullName || m.name,
                  isActive: m.isActive,
                  startDate: (m.startDate || '') + (m.startDate && m.startDate.length === 7 ? '-01' : ''),
                  payments: payments
                };
              });
            }
          } catch (e) { console.warn('JSON fallback load failed', e); }
        }

        window.__members = members;
        renderStats(members);
        renderList(members);
      }, async (err) => {
        console.warn('onSnapshot error; falling back to local JSON', err);
        try {
          const res = await fetch('cleaned_members_final.json', { cache: 'no-store' });
          if (res.ok) {
            const raw = await res.json();
            const members = raw.map(m => {
              const payments = m.payments || m.paymentsDues || {};
              return {
                id: String(m.memberId || m.id || ''),
                memberId: m.memberId,
                fullName: m.fullName || m.name,
                isActive: m.isActive,
                startDate: (m.startDate || '') + (m.startDate && m.startDate.length === 7 ? '-01' : ''),
                payments
              };
            });
            window.__members = members;
            renderStats(members);
            renderList(members);
          } else {
            console.error('Fallback JSON load failed', res.status);
          }
        } catch (e) {
          console.error('Fallback JSON exception', e);
        }
      });
    }

    function setupAuth() {
      const { auth } = window.firebaseServices || {};
      if (!auth) return;
      const signInBtn = document.getElementById('btnSignIn');
      const signInEmailBtn = document.getElementById('btnSignInEmail');
      const signOutBtn = document.getElementById('btnSignOut');
      signInBtn.onclick = async () => { try { await auth.signInAnonymously(); } catch(e){ alert('Signin failed'); } };
      signInEmailBtn.onclick = async () => {
        const email = prompt('Enter email:');
        if (!email) return;
        const password = prompt('Enter password:');
        if (!password) return;
        try { await auth.signInWithEmailAndPassword(email, password); }
        catch(e){ alert('Email sign-in failed: ' + (e && e.message ? e.message : e)); }
      };
      signOutBtn.onclick = async () => { try { await auth.signOut(); } catch(e){ alert('Signout failed'); } };
      auth.onAuthStateChanged(async user => {
        const showSignedOut = user ? 'none' : '';
        signInBtn.style.display = showSignedOut;
        signInEmailBtn.style.display = showSignedOut;
        signOutBtn.style.display = user ? '' : 'none';
        // Load role document if signed in
        try {
          window.__role = 'member';
          if (user && window.firebaseServices && window.firebaseServices.db) {
            const snap = await window.firebaseServices.db.collection('roles').doc(user.uid).get();
            if (snap.exists && snap.data() && snap.data().role) {
              window.__role = snap.data().role;
            }
          }
        } catch(_) { window.__role = 'member'; }
        if (window.__members) renderList(window.__members);
      });
    }

    let unsubscribe = null;
    window.addEventListener('DOMContentLoaded', async () => {
      setupAuth();
      if (USE_LOCAL_ONLY) {
        try {
          const members = await loadLocalJsonMembers();
          window.__members = members;
          renderStats(members);
          renderList(members);
        } catch (e) { console.error(e); }
        return;
      }

      const { auth } = window.firebaseServices || {};
      if (auth) {
        try { if (!auth.currentUser) await auth.signInAnonymously(); } catch(_){}
        if (unsubscribe) try { unsubscribe(); } catch(_){}
        unsubscribe = attachRealtime();
        auth.onAuthStateChanged(async () => {
          if (unsubscribe) try { unsubscribe(); } catch(_){}
          unsubscribe = attachRealtime();
        });
      } else {
        try {
          const members = await loadLocalJsonMembers();
          window.__members = members;
          renderStats(members);
          renderList(members);
        } catch(_){}
      }
      document.getElementById('refresh').onclick = () => {
        if (window.__members) {
          renderStats(window.__members);
          renderList(window.__members);
        }
      };
      document.getElementById('search').addEventListener('input', () => {
        if (window.__members) renderList(window.__members);
      });
      document.getElementById('filterStatus').addEventListener('change', () => {
        if (window.__members) renderList(window.__members);
      });
      // Payment modal handlers
      document.getElementById('pcancel').onclick = closePaymentModal;
      document.getElementById('psave').onclick = savePayment;
    });

    window.addEventListener('unload', () => { if (typeof unsubscribe === 'function') unsubscribe(); });

    // --- Admin: Record Payment & Reminder ---
    function findMemberById(id) {
      return (window.__members || []).find(m => String(m.id) === String(id));
    }

    function openPaymentModal(memberId) {
      const m = findMemberById(memberId);
      if (!m) return alert('Member not found');
      document.getElementById('pmember').textContent = `${m.fullName} (ID ${m.memberId || m.id})`;
      document.getElementById('pamount').value = '';
      document.getElementById('ptype').value = 'monthly';
      document.getElementById('ppreview').textContent = '';
      const modal = document.getElementById('paymentModal');
      modal.style.display = 'flex';
      modal.setAttribute('data-id', m.id);
    }

    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.style.display = 'none';
      modal.removeAttribute('data-id');
    }

    function distributeToUnpaidMonths(amount, payments) {
      const map = { ...(payments || {}) };
      let remaining = Number(amount) || 0;
      const iter = new Date(Date.UTC(2022,0,1));
      const end = new Date(Date.UTC(CURRENT_DATE.getUTCFullYear(), CURRENT_DATE.getUTCMonth(), 1));
      while (iter <= end && remaining >= DUE_PER_MONTH) {
        const key = monthKey(iter);
        const paid = Number(map[key] || 0);
        if (paid < DUE_PER_MONTH) {
          const need = DUE_PER_MONTH - paid;
          const apply = Math.min(need, remaining);
          map[key] = paid + apply;
          remaining -= apply;
        }
        iter.setUTCMonth(iter.getUTCMonth() + 1);
      }
      return { map, remaining };
    }

    async function savePayment() {
      const { db, auth } = window.firebaseServices || {};
      if (!db) return alert('Firebase not initialized');
      const modal = document.getElementById('paymentModal');
      const memberId = modal.getAttribute('data-id');
      const m = findMemberById(memberId);
      if (!m) return alert('Member not found');
      const amount = Number(document.getElementById('pamount').value || 0);
      const type = document.getElementById('ptype').value;
      if (!(amount > 0)) return alert('Enter a valid amount');

      try {
        const docRef = db.collection('members').doc(String(m.id));
        if (type === 'monthly') {
          const dist = distributeToUnpaidMonths(amount, m.payments || {});
          await docRef.set({ payments: dist.map }, { merge: true });
        } else {
          // For incidental/registration we log to an array field for now
          const field = type === 'registration' ? 'registrationPayments' : 'incidentalPayments';
          const entry = { amount, at: new Date().toISOString(), by: (auth && auth.currentUser && auth.currentUser.email) || 'admin' };
          const payload = {};
          payload[field] = firebase.firestore.FieldValue.arrayUnion(entry);
          await docRef.set(payload, { merge: true });
        }
        closePaymentModal();
      } catch (e) {
        console.error(e);
        alert('Failed to save payment');
      }
    }

    async function generateReminder(memberId) {
      const m = findMemberById(memberId);
      if (!m) return alert('Member not found');
      const f = calculateMemberFinancials(m);
      const owed = f.balance < 0 ? Math.abs(f.balance).toFixed(2) : '0.00';
      const msg = `ሰላም ${m.fullName},\n\nበአሁኑ ጊዜ የወርሃዊ ክፍያ ቀሪ ዕለት $${owed} አለ። እባክዎ ክፍያውን በተመጣጣኝ ጊዜ ይፈፅሙ።\n\nእናመሰግናለን!`;
      try { await navigator.clipboard.writeText(msg); alert('Reminder copied to clipboard'); } catch(_) { alert('Could not copy to clipboard'); }
    }
  </script>
</body>
</html>


