<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AAAC Dashboard v2 (Firestore)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f8fafc; color:#0f172a; }
    header { padding: 16px; background:#0ea5e9; color:white; }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 12px 0; }
    .card { background:white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 14px; }
    .row { display:flex; gap: 10px; align-items:center; }
    .list { display:grid; gap:8px; margin-top: 16px; }
    .member { background:white; border:1px solid #e2e8f0; border-radius:8px; padding:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size: 12px; }
    .badge.current{ background:#dcfce7; color:#166534; }
    .badge.behind{ background:#fee2e2; color:#991b1b; }
    .muted { color:#475569; font-size: 13px; }
    button { background:#0ea5e9; color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#e2e8f0; color:#0f172a; }
    .warn { color:#b91c1c; }
    .green { color:#166534; }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <!-- Inline config fallback to avoid Pages loading issues -->
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyDa4rimRWUUgPp7LAAaZzyrn13MKM-9naA",
      authDomain: "aaac-membership-1221.firebaseapp.com",
      projectId: "aaac-membership-1221",
      storageBucket: "aaac-membership-1221.firebasestorage.app",
      messagingSenderId: "134230731518",
      appId: "1:134230731518:web:2eb24bfa5cb9e9df2453af",
      measurementId: "G-YJJD19WXBG",
    };
  </script>
  <script src="firebase-init.js"></script>
</head>
<body>
  <header>
    <div class="row" style="justify-content: space-between;">
      <div>
        <div style="font-weight:700; font-size:18px;">AAAC Membership System — v2 (Firestore)</div>
        <div class="muted">Real-time, single source of truth. September 2025 calculations.</div>
      </div>
      <div class="row">
        <button id="btnSignInEmail" class="secondary">Sign in with Email</button>
        <button id="btnSignIn" class="secondary">Sign in Anonymously</button>
        <button id="btnSignOut" class="secondary" style="display:none;">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <div class="cards">
      <div class="card"><div>Total Members</div><div id="statTotal" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Current</div><div id="statCurrent" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Behind</div><div id="statBehind" style="font-size:24px; font-weight:700;">—</div></div>
      <div class="card"><div>Owed by Active</div><div id="statOwed" style="font-size:24px; font-weight:700;">—</div></div>
    </div>

    <div class="row" style="gap:8px;">
      <input id="search" placeholder="Search by name or member ID..." style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px;" />
      <select id="statusFilter" style="padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
        <option value="">All Status</option>
        <option value="ahead">Ahead</option>
        <option value="current">Current</option>
        <option value="behind">Behind</option>
        <option value="issue">Issue (3-5 months)</option>
        <option value="risk">Risk (6+ months)</option>
        <option value="inactive">Inactive</option>
      </select>
      <button id="refresh">Recalculate</button>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:600; margin-bottom:8px;">Admin Actions</div>
      <div class="row" style="gap:8px; flex-wrap: wrap;">
        <button id="btnAddMember" class="secondary" style="display:none;">Add Member</button>
        <button id="btnRecordPaymentGlobal" class="secondary" style="display:none;">Record Payment (by Member ID)</button>
        <button id="btnGenerateReminders" class="secondary" style="display:none;">Generate Reminders</button>
        <button id="btnLinkAccount" class="secondary">Link My Account to Member ID</button>
        <span id="roleBadge" class="muted" style="margin-left:auto;">Role: guest</span>
      </div>
    </div>

    <div id="list" class="list"></div>
  </main>

  <script>
    const CURRENT_DATE = new Date('2025-09-01T00:00:00Z');
    const DUE_PER_MONTH = 15; // USD

    function monthKey(date) { return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}`; }

    function calculateMemberFinancials(member) {
      // Expected member schema (Firestore):
      // members/{memberId}: {
      //   fullName,
      //   isActive,
      //   paymentsDues: { [YYYY-MM]: number }, // dues-only map
      //   joiningFeeAmount?: number,            // one-time $200 joining fee (not counted toward dues)
      //   joiningFeeDate?: string               // ISO date when fee was paid
      // }
      // Backwards-compat: fall back to legacy `payments` if `paymentsDues` is absent
      const payments = member.paymentsDues || member.payments || {};
      
      // Use September 2025 as the baseline start date
      const start = new Date(member.startDate || '2025-09-01T00:00:00Z');
      const iter = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), 1));
      const end = new Date(Date.UTC(CURRENT_DATE.getUTCFullYear(), CURRENT_DATE.getUTCMonth(), 1));
      
      let totalOwed = 0;
      let totalPaid = 0;
      let monthsBehind = 0;
      let paidUpTo = null;
      let currentMonth = new Date(Date.UTC(CURRENT_DATE.getUTCFullYear(), CURRENT_DATE.getUTCMonth(), 1));

      // Calculate from start date to current month
      while (iter <= end) {
        const key = monthKey(iter);
        const paid = Number(payments[key] || 0);
        totalPaid += paid;
        totalOwed += DUE_PER_MONTH;
        
        if (paid >= DUE_PER_MONTH) {
          paidUpTo = new Date(iter);
        } else {
          monthsBehind += 1;
        }
        iter.setUTCMonth(iter.getUTCMonth() + 1);
      }

      // Check future payments to extend paidUpTo
      const currentKey = monthKey(currentMonth);
      const futureKeys = Object.keys(payments).filter(k => k > currentKey).sort();
      for (const k of futureKeys) {
        if (Number(payments[k] || 0) >= DUE_PER_MONTH) {
          const [y, m] = k.split('-').map(Number);
          paidUpTo = new Date(Date.UTC(y, m - 1, 1));
        } else {
          break;
        }
      }

      // Calculate balance: positive = ahead, negative = owes
      const balance = totalPaid - totalOwed;

      // Determine status
      let status = 'current';
      if (!member.isActive) {
        status = 'inactive';
      } else if (balance < 0) {
        if (monthsBehind >= 6) status = 'risk';
        else if (monthsBehind >= 3) status = 'issue';
        else status = 'behind';
      } else if (balance > 0) {
        status = 'ahead';
      }

      return { 
        balance, 
        monthsBehind, 
        paidUpTo, 
        status, 
        totalOwed, 
        totalPaid 
      };
    }

    function renderStats(members) {
      const role = window.__role || 'guest';
      const isPrivileged = role === 'admin' || role === 'board';

      let total = members.length;
      let current = 0; 
      let behind = 0; 
      let totalOwed = 0;
      let totalAhead = 0;
      
      members.forEach(m => {
        const f = calculateMemberFinancials(m);
        if (m.isActive) {
          if (f.balance < 0) {
            behind += 1;
            totalOwed += Math.abs(f.balance);
          } else if (f.balance > 0) {
            current += 1;
            totalAhead += f.balance;
          } else {
            current += 1; // balance = 0 means current
          }
        }
      });

      const statTotalEl = document.getElementById('statTotal');
      const statCurrentEl = document.getElementById('statCurrent');
      const statBehindEl = document.getElementById('statBehind');
      const statOwedEl = document.getElementById('statOwed');

      if (isPrivileged) {
        // Admin/Board: show all stats as-is
        statTotalEl.textContent = total;
        statCurrentEl.textContent = current;
        statBehindEl.textContent = behind;
        statOwedEl.textContent = `$${totalOwed.toFixed(2)}`;

        // Ensure cards are visible
        [statCurrentEl, statBehindEl, statOwedEl].forEach(el => {
          const card = el && el.closest && el.closest('.card');
          if (card) card.style.display = '';
        });
      } else {
        // Member/Guest: show only active member count; hide other cards
        statTotalEl.textContent = current; // repurpose as Active Members
        [statCurrentEl, statBehindEl, statOwedEl].forEach(el => {
          const card = el && el.closest && el.closest('.card');
          if (card) card.style.display = 'none';
        });
      }
    }

    function formatPaidUpTo(date) {
      if (!date) return 'Not Started';
      return date.toLocaleString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
    }

    function renderList(members) {
      const q = document.getElementById('search').value.trim().toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const container = document.getElementById('list');
      container.innerHTML = '';
      members
        .filter(m => {
          // Text search
          if (q && !(m.fullName || '').toLowerCase().includes(q) && !String(m.memberId || m.id || '').includes(q)) {
            return false;
          }
          // Status filter
          if (statusFilter) {
            const f = calculateMemberFinancials(m);
            if (statusFilter === 'inactive' && m.isActive) return false;
            if (statusFilter !== 'inactive' && !m.isActive) return false;
            if (statusFilter !== 'inactive' && f.status !== statusFilter) return false;
          }
          return true;
        })
        .slice(0, 250)
        .forEach(m => {
          const f = calculateMemberFinancials(m);
          const div = document.createElement('div');
          div.className = 'member';
          const statusClass = (f.status === 'current' || f.status === 'ahead') ? 'current' : 'behind';
          const balanceEl = f.balance < 0 ? `<span class="warn">-$${Math.abs(f.balance).toFixed(2)}</span>` : `<span class="green">$${f.balance.toFixed(2)}</span>`;
          // Assume all existing members have paid joining fee unless explicitly marked as not paid
          // Only show "Not paid" if explicitly set to 0 or if it's a very new member (created after this update)
          const joiningFeePaid = m.joiningFeeAmount !== 0; // undefined/null means paid, only 0 means not paid
          const joiningFeeLine = `<div class="muted" style="margin-top:4px;">Joining fee: ${joiningFeePaid ? 'Paid' : 'Not paid'}${joiningFeePaid && m.joiningFeeDate ? ` on ${new Date(m.joiningFeeDate).toLocaleDateString()}` : ''}</div>`;
          
          // Show phone number only to admin/board
          const role = window.__role || 'guest';
          const isPrivileged = role === 'admin' || role === 'board';
          const phoneLine = (isPrivileged && m.phone) ? `<div class="muted" style="margin-top:4px;">Phone: ${m.phone}</div>` : '';
          
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:600;">${m.fullName || 'Unnamed'}</div>
                <div class="muted">Member ID: ${m.memberId || '—'}</div>
              </div>
              <span class="badge ${statusClass}">${f.status}</span>
            </div>
            <div class="muted" style="margin-top:6px;">Balance: ${balanceEl} • Months behind: ${f.monthsBehind} • Paid up to: ${formatPaidUpTo(f.paidUpTo)}</div>
            ${joiningFeeLine}
            ${phoneLine}
          `;
          const btn = document.createElement('button');
          btn.textContent = 'Record Payment';
          btn.className = 'secondary';
          btn.style.marginTop = '8px';
          btn.onclick = () => recordPaymentForMember(m.memberId || m.id);
          div.appendChild(btn);

          container.appendChild(div);
        });
    }

    function getFilteredMembers(allMembers) {
      const { auth } = window.firebaseServices || {};
      const role = window.__role || 'guest';
      const roleLink = window.__linkedMemberIdFromRole || null;
      const link = roleLink || window.localStorage.getItem('linkedMemberId');
      const isPrivileged = role === 'admin' || role === 'board';
      // If admin/board: see all; otherwise, if a link is set and user is signed in, filter to self
      if (!isPrivileged && auth && auth.currentUser && link) {
        return allMembers.filter(m => String(m.memberId || m.id) === String(link));
      }
      return allMembers;
    }

    function refreshFilter() {
      const all = window.__allMembers || [];
      const filtered = getFilteredMembers(all);
      window.__members = filtered;
      renderStats(all);
      renderList(filtered);
    }

    function attachRealtime() {
      const { db, auth } = window.firebaseServices || {};
      if (!db) {
        alert('Firebase not initialized. Create docs/firebase-config.js from the example and reload.');
        return () => {};
      }
      // Load role mapping from roles/{uid} if signed in
      const setRoleBadge = (role) => { document.getElementById('roleBadge').textContent = `Role: ${role || 'guest'}`; };
      const uid = (auth && auth.currentUser) ? auth.currentUser.uid : null;
      if (uid) {
        db.collection('roles').doc(uid).get().then(doc => {
          const data = doc.exists ? (doc.data() || {}) : {};
          const role = data.role || 'member';
          const roleLinkedMemberId = data.memberId ? String(data.memberId) : null;
          window.__role = role;
          window.__linkedMemberIdFromRole = roleLinkedMemberId;
          setRoleBadge(role);
          // Toggle admin UI
          const adminBtns = ['btnAddMember','btnRecordPaymentGlobal','btnGenerateReminders'];
          adminBtns.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = (role === 'admin' || role === 'board') ? '' : 'none';});
          // After role resolved, (re)subscribe appropriately
          if (typeof window.__unsubscribe === 'function') window.__unsubscribe();
          window.__unsubscribe = subscribeMembersStream();
        }).catch(()=> setRoleBadge('guest'));
      } else {
        // Signed out: set guest, clear any active subscriptions and UI
        setRoleBadge('guest');
        if (typeof window.__unsubscribe === 'function') {
          window.__unsubscribe();
          window.__unsubscribe = null;
        }
        window.__role = 'guest';
        window.__allMembers = [];
        renderStats([]);
        renderList([]);
        // Do NOT subscribe when signed out (rules likely block reads when unauthenticated)
      }

      function subscribeMembersStream() {
        const role = window.__role || 'guest';
        const roleLink = window.__linkedMemberIdFromRole || null;
        const link = roleLink || window.localStorage.getItem('linkedMemberId');
        const isPrivileged = role === 'admin' || role === 'board';
        if (!isPrivileged && link) {
          // Subscribe to a single member doc to satisfy restrictive rules
          return db.collection('members').doc(String(link)).onSnapshot((doc) => {
            const members = doc.exists ? [{ id: doc.id, ...doc.data() }] : [];
            window.__allMembers = members;
            refreshFilter();
          }, (err) => {
            console.error('onSnapshot(doc) error', err);
            // Suppress noisy alerts if signed out; otherwise show helpful message
            const currentUser = (auth && auth.currentUser) ? auth.currentUser : null;
            if (currentUser) {
              alert('Realtime subscription failed (doc). Link a valid Member ID or relax rules.');
            }
          });
        }
        // Admin/board (or no link): subscribe to full collection
        return db.collection('members').onSnapshot((snap) => {
          const members = [];
          snap.forEach(doc => members.push({ id: doc.id, ...doc.data() }));
          window.__allMembers = members;
          refreshFilter();
        }, (err) => {
          console.error('onSnapshot(col) error', err);
          const currentUser = (auth && auth.currentUser) ? auth.currentUser : null;
          if (currentUser) {
            alert('Realtime subscription failed. Check Firestore rules and network.');
          }
        });
      }

      return subscribeMembersStream();
    }

    function setupAuth() {
      const { auth } = window.firebaseServices || {};
      if (!auth) return;
      const signInEmailBtn = document.getElementById('btnSignInEmail');
      const signInBtn = document.getElementById('btnSignIn');
      const signOutBtn = document.getElementById('btnSignOut');
      
      // Email/Password sign-in
      signInEmailBtn.onclick = async () => {
        const email = prompt('Enter email:');
        if (!email) return;
        const password = prompt('Enter password:');
        if (!password) return;
        try {
          await auth.signInWithEmailAndPassword(email, password);
          alert('Signed in successfully!');
        } catch(e) {
          alert('Sign in failed: ' + e.message);
        }
      };
      
      signInBtn.onclick = async () => { try { await auth.signInAnonymously(); } catch(e){ alert('Signin failed'); } };
      signOutBtn.onclick = async () => {
        try {
          // Proactively tear down subscription before signing out to avoid transient errors
          if (typeof window.__unsubscribe === 'function') {
            window.__unsubscribe();
            window.__unsubscribe = null;
          }
          await auth.signOut();
        } catch(e){ alert('Signout failed'); }
      };
      auth.onAuthStateChanged(user => {
        signInEmailBtn.style.display = user ? 'none' : '';
        signInBtn.style.display = user ? 'none' : '';
        signOutBtn.style.display = user ? '' : 'none';
        if (user) {
          // Re-attach realtime to load role and filter
          if (typeof window.__unsubscribe === 'function') window.__unsubscribe();
          window.__unsubscribe = attachRealtime();
        } else {
          // Ensure no subscriptions remain and UI reflects signed-out state
          if (typeof window.__unsubscribe === 'function') {
            window.__unsubscribe();
            window.__unsubscribe = null;
          }
          const roleBadge = document.getElementById('roleBadge');
          if (roleBadge) roleBadge.textContent = 'Role: guest';
          const adminBtns = ['btnAddMember','btnRecordPaymentGlobal'];
          adminBtns.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none';});
          window.__role = 'guest';
          window.__allMembers = [];
          renderStats([]);
          renderList([]);
        }
      });
    }

    // --- Firestore write helpers ---
    async function addMemberFlow() {
      const { db } = window.firebaseServices || {};
      if (!db) return alert('Firebase not initialized');
      const memberId = prompt('Member ID (required):');
      if (!memberId) return;
      const fullName = prompt('Full name (required):');
      if (!fullName) return;
      const start = prompt('Start date (YYYY-MM or YYYY-MM-DD). Default 2025-01-01:', '2025-01-01') || '2025-01-01';
      try {
        await db.collection('members').doc(String(memberId)).set({
          memberId: String(memberId),
          fullName,
          isActive: true,
          startDate: start,
          paymentsDues: {},
          joiningFeeAmount: 0, // New members start with joining fee not paid
          joiningFeeDate: null,
        }, { merge: true });
        alert('Member added.');
      } catch (e) {
        console.error(e); alert('Failed to add member: ' + (e.message || e));
      }
    }

    async function recordPaymentForMember(memberId) {
      const { db } = window.firebaseServices || {};
      if (!db) return alert('Firebase not initialized');
      const type = prompt('Payment type: dues or joining (enter "dues" or "joining"):', 'dues');
      if (!type) return;
      if (type === 'joining') {
        // Record one-time $200 joining fee
        try {
          await db.collection('members').doc(String(memberId)).set({
            joiningFeeAmount: 200,
            joiningFeeDate: new Date().toISOString(),
          }, { merge: true });
          alert('Joining fee recorded.');
        } catch (e) {
          console.error(e); alert('Failed to record joining fee: ' + (e.message || e));
        }
        return;
      }
      // Otherwise record dues payment
      const month = prompt('Payment month (YYYY-MM):');
      if (!month || !/^\d{4}-\d{2}$/.test(month)) return alert('Invalid month format.');
      const amountStr = prompt('Dues amount (e.g., 15):', '15');
      const amount = Number(amountStr);
      if (!isFinite(amount) || amount <= 0) return alert('Invalid amount.');
      try {
        const inc = firebase.firestore.FieldValue.increment(amount);
        await db.collection('members').doc(String(memberId)).set({
          paymentsDues: { [month]: inc },
          isActive: true,
        }, { merge: true });
        alert('Dues payment recorded.');
      } catch (e) {
        console.error(e); alert('Failed to record dues: ' + (e.message || e));
      }
    }

    async function recordPaymentGlobalFlow() {
      const id = prompt('Member ID to credit:');
      if (!id) return;
      await recordPaymentForMember(id);
    }

    function linkAccountFlow() {
      const { auth } = window.firebaseServices || {};
      if (!auth || !auth.currentUser) {
        alert('Please sign in first (Anonymous is fine).');
        return;
      }
      const id = prompt('Enter your Member ID to link this login:');
      if (!id) return;
      window.localStorage.setItem('linkedMemberId', String(id));
      refreshFilter();
    }

    function generateReminders() {
      // Use currently displayed/filtered members instead of all behind members
      const members = window.__members || [];
      
      if (members.length === 0) {
        alert('No members to generate reminders for. Try adjusting your filters.');
        return;
      }

      let reminders = '=== AAAC Payment Reminders ===\n\n';
      
      members.forEach(m => {
        const f = calculateMemberFinancials(m);
        const balance = Math.abs(f.balance);
        const monthsBehind = f.monthsBehind;
        
        // Amharic reminder message (using established text from previous builds)
        const amharicMessage = `የአዲስ አበባ ማሕበር በቺካጎ ክፍያ ማስታወሻ

ውድ ${m.fullName || 'አባል'}

የአዲስ አበባ ማሕበር በቺካጎ አባልነትዎ ቀሪ ሂሳብ $${balance.toFixed(2)} ነው።
የተቀሩ ወራት: ${monthsBehind}
አባል መለያ: ${m.memberId || 'N/A'}

ክፍያውን በ Zelle ለመላክ: aaaichicago@gmail.com ይጠቀሙና ሒሳቦትን ይከፍሉ ዘንድ በትሕትና እንጠይቃለን።

ከምስጋና ጋር
የአዲስ አበባ ማሕበር በቺካጎ ቦርድ`;
        
        const phoneInfo = m.phone ? ` | Phone: ${m.phone}` : '';
        reminders += `--- ${m.fullName || 'Unnamed'} (ID: ${m.memberId || 'N/A'})${phoneInfo} ---\n`;
        reminders += `Balance: $${balance.toFixed(2)} | Months behind: ${monthsBehind}\n`;
        reminders += `Amharic Message:\n${amharicMessage}\n`;
        reminders += `English Message:\n`;
        reminders += `Hello ${m.fullName || 'there'},\n\n`;
        reminders += `This is a friendly reminder about your AAAC membership dues.\n\n`;
        reminders += `Amount owed: $${balance.toFixed(2)}\n`;
        reminders += `Months behind: ${monthsBehind}\n`;
        reminders += `Member ID: ${m.memberId || 'N/A'}\n`;
        if (m.phone) {
          reminders += `Phone: ${m.phone}\n`;
        }
        reminders += `\nPlease make your payment soon. Contact us for more information.\n\n`;
        reminders += `Thank you,\nAAAC Administration\n\n`;
        reminders += '='.repeat(50) + '\n\n';
      });

      // Show in a popup for easy copying
      const popup = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
      popup.document.write(`
        <html>
          <head><title>AAAC Payment Reminders</title></head>
          <body style="font-family: monospace; white-space: pre-wrap; padding: 20px;">
            ${reminders}
          </body>
        </html>
      `);
      
      alert(`Generated reminders for ${members.length} members. Check the popup window to copy the messages.`);
    }

    let unsubscribe = null;
    window.addEventListener('DOMContentLoaded', () => {
      setupAuth();
      unsubscribe = attachRealtime();
      document.getElementById('refresh').onclick = () => {
        if (window.__members) {
          renderStats(window.__members);
          renderList(window.__members);
        }
      };
      document.getElementById('search').addEventListener('input', () => {
        if (window.__members) renderList(window.__members);
      });
      document.getElementById('btnAddMember').onclick = addMemberFlow;
      document.getElementById('btnRecordPaymentGlobal').onclick = recordPaymentGlobalFlow;
      document.getElementById('btnGenerateReminders').onclick = generateReminders;
      document.getElementById('btnLinkAccount').onclick = linkAccountFlow;
      document.getElementById('statusFilter').addEventListener('change', () => {
        if (window.__members) renderList(window.__members);
      });
    });

    window.addEventListener('unload', () => { if (typeof unsubscribe === 'function') unsubscribe(); });
  </script>
</body>
</html>


