<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAAC Membership Status Tracker</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .security-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover { transform: translateY(-2px); }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #667eea;
            color: white;
        }

        .filter-tab:hover {
            background: #5a6fd8;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
        }

        .members-section {
            margin: 20px 0;
        }
        
        .members-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 2px solid #e9ecef;
        }
        
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .member-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .member-card.inactive {
            opacity: 0.7;
            background: #f8f9fa;
        }
        
        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .member-id {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .member-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .member-status.current { background: #d4edda; color: #155724; }
        .member-status.issue { background: #fff3cd; color: #856404; }
        .member-status.risk { background: #f8d7da; color: #721c24; }
        .member-status.risk-of-removal { background: #dc3545; color: #ffffff; }
        .member-status.inactive { background: #e2e3e5; color: #383d41; }
        
        .member-info {
            margin-bottom: 15px;
        }
        
        .member-name {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .member-id {
            color: #6c757d;
            font-size: 14px;
        }
        
        .member-balance {
            margin-bottom: 15px;
        }
        
        .balance-amount {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .balance-amount.positive { color: #28a745; }
        .balance-amount.negative { color: #dc3545; }
        
        .balance-details {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .paid-up-to {
            color: #495057;
            font-size: 13px;
            font-style: italic;
        }
        
        .debug-info {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-record, .btn-reminder {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-record {
            background: #28a745;
            color: white;
        }
        
        .btn-reminder {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-record:hover, .btn-reminder:hover {
            transform: translateY(-1px);
        }
        
        .inactive-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
        }

        .member-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .member-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .member-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .member-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .status-current { background: #d4edda; color: #155724; }
        .status-issue { background: #fff3cd; color: #856404; }
        .status-risk { background: #f8d7da; color: #721c24; }
        .status-removed { background: #e2e3e5; color: #383d41; }

        .balance {
            font-weight: bold;
        }

        .balance-positive { color: #28a745; }
        .balance-negative { color: #dc3545; }

        .balance-details {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover { color: #000; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .member-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .member-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
        }

        .detail-value {
            color: #6c757d;
        }

        .year-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .year-tab {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .year-tab.active {
            background: #667eea;
            color: white;
        }

        .year-tab:hover {
            background: #5a6fd8;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .search-section { flex-direction: column; }
            .stats { grid-template-columns: 1fr; }
            .member-table { font-size: 14px; }
            .member-table th, .member-table td { padding: 10px 8px; }
            .year-tabs { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            <h1>·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·ã®·ä†·â£·àç·äê·âµ ·åà·åΩ</h1>
            <p>·ä≠·çç·ã´·äï ·ä•·äï·ã≤·àÅ·àù ·ä†·â£·àç·äê·âµ ·âÅ·å•·à≠·äï ·àõ·à®·åã·åà·å´</p>
            <p><strong>Current Date: August 2025</strong></p>
        </div>

        <div class="controls">
            <div class="search-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by name, phone number, or member ID...">
                <button class="btn btn-primary" onclick="searchMembers()">Search</button>
                <button class="btn btn-success" onclick="addNewMember()">Add New Member</button>
                <button class="btn btn-info" onclick="viewMemberDetails()">View Details</button>
                <button class="btn btn-warning" onclick="exportData()">Export Data</button>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterByStatus('all')">All Members</button>
                <button class="filter-tab" onclick="filterByStatus('current')">‚úÖ Current</button>
                <button class="filter-tab" onclick="filterByStatus('issue')">‚ö†Ô∏è Issues (6-12 months)</button>
                <button class="filter-tab" onclick="filterByStatus('risk')">‚ùå Risk (1-2 years)</button>
                <button class="filter-tab" onclick="filterByStatus('removed')">üö´ Removed (2+ years)</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-members">0</div>
                    <div class="stat-label">Total Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-members">0</div>
                    <div class="stat-label">‚úÖ Current</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="issue-members">0</div>
                    <div class="stat-label">‚ö†Ô∏è Issues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="risk-members">0</div>
                    <div class="stat-label">‚ùå Risk</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="risk-of-removal-members">0</div>
                    <div class="stat-label">üö® Risk of Removal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-balance">0</div>
                    <div class="stat-label">Total Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inactive-members">0</div>
                    <div class="stat-label">Inactive Members</div>
                </div>
            </div>
        </div>

        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading member data...</p>
            </div>
            
            <div id="members-container">
                <!-- Members will be displayed here -->
            </div>
            
            <table class="member-table" id="memberTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Registration</th>
                        <th>Paid Up To</th>
                        <th>Current Balance</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="memberTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div id="memberDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Member Payment Details</h2>
            <div id="memberDetailsContent">
                <!-- Member details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Record Payment</h2>
            <div class="payment-info">
                <strong>Payment Instructions:</strong><br>
                ‚Ä¢ Monthly fee: $15 per member<br>
                ‚Ä¢ Initial registration: $200<br>
                ‚Ä¢ Send payment via Zelle to: aaaichicago@gmail.com<br>
                ‚Ä¢ Include member name in payment description
            </div>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="memberName">Member Name:</label>
                    <input type="text" id="memberName" readonly>
                </div>
                <div class="form-group">
                    <label for="paymentYear">Payment Year:</label>
                    <select id="paymentYear" required>
                        <option value="">Select Year</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentType">Payment Type:</label>
                    <select id="paymentType" required>
                        <option value="">Select Type</option>
                        <option value="monthly">Monthly Payment</option>
                        <option value="incidental">Incidental (Funeral, etc.)</option>
                        <option value="registration">Registration Fee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentMonth">Payment Month:</label>
                    <select id="paymentMonth" required>
                        <option value="">Select Month</option>
                        <option value="JAN">January</option>
                        <option value="FEB">February</option>
                        <option value="MAR">March</option>
                        <option value="APR">April</option>
                        <option value="MAY">May</option>
                        <option value="JUNE">June</option>
                        <option value="JULY">July</option>
                        <option value="AUG">August</option>
                        <option value="SEPT">September</option>
                        <option value="OCT">October</option>
                        <option value="NOV">November</option>
                        <option value="DEC">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount ($):</label>
                    <input type="number" id="paymentAmount" value="15" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="paymentNotes">Notes (optional):</label>
                    <input type="text" id="paymentNotes" placeholder="Payment reference or notes">
                </div>
                <button type="submit" class="btn btn-success">Record Payment</button>
            </form>
        </div>
    </div>

    <!-- Google Sheets Integration -->
            <script src="google_sheets_integration.js?v=20250203"></script>

    <script>
        let membersData = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        const MONTHLY_FEE = 15;
        const OLD_REGISTRATION_FEE = 100; // For existing members
        const NEW_REGISTRATION_FEE = 200; // For new members (2023+)
        const INCIDENTAL_FEE = 10; // For funeral contributions, etc.
        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Set the current date to August 2025 for testing
        // In production, this would be the actual current date
        const CURRENT_DATE = new Date(2025, 7, 1); // August 1, 2025
        const CURRENT_YEAR = CURRENT_DATE.getFullYear();
        const CURRENT_MONTH = CURRENT_DATE.getMonth();

        // Authentication check
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('aaacAuthenticated');
            const userRole = sessionStorage.getItem('aaacUserRole');
            
            // If no authentication, set as demo user and continue
            if (!isAuthenticated || !userRole) {
                console.log('No authentication found, setting as demo user');
                sessionStorage.setItem('aaacAuthenticated', 'true');
                sessionStorage.setItem('aaacUserRole', 'demo');
                sessionStorage.setItem('aaacLoginTime', new Date().getTime());
                return true;
            }
            return true;
        }

        // Logout function
        function logout() {
            console.log('Logout function called');
            sessionStorage.removeItem('aaacAuthenticated');
            sessionStorage.removeItem('aaacUserRole');
            sessionStorage.removeItem('aaacLoginTime');
            console.log('Session storage cleared, redirecting to login...');
            window.location.href = 'login.html';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM CONTENT LOADED ===');
            console.log('Checking authentication...');
            
            const authResult = checkAuthentication();
            console.log('Authentication result:', authResult);
            
            if (!authResult) {
                console.log('Authentication failed, stopping initialization');
                return;
            }
            
            console.log('Authentication passed, loading member data...');
            
            // Check for Google Sheets integration
            if (window.GoogleSheetsIntegration && typeof window.GoogleSheetsIntegration.initialize === 'function') {
                console.log('üîÑ Attempting Google Sheets integration...');
                window.GoogleSheetsIntegration.initialize().then(success => {
                    if (success) {
                        console.log('‚úÖ Using Google Sheets data');
                        return; // Google Sheets will handle the display
                    } else {
                        console.log('‚ö†Ô∏è Google Sheets failed, using local data');
                        loadMembersData();
                    }
                }).catch(error => {
                    console.log('‚ö†Ô∏è Google Sheets integration not available, using local data');
                    loadMembersData();
                });
            } else {
                console.log('‚ö†Ô∏è Google Sheets integration not available, using local data');
                loadMembersData();
            }
            
            // Fallback to local CSV data
            console.log('üîÑ Loading local CSV data...');
            loadMembersData();
            
            setupEventListeners();
            console.log('=== INITIALIZATION COMPLETE ===');
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', function() {
                searchMembers();
            });

            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                recordPayment();
            });

            // Add logout button event listener
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    logout();
                });
            }
        }

        function loadMembersData() {
            console.log('=== STARTING DATA LOAD PROCESS ===');
            console.log('Starting to load member data...');
            
            // Check user role to determine which data to load
            const userRole = sessionStorage.getItem('aaacUserRole');
            console.log('User role:', userRole);
            
            let dataFile = 'data/AAAC_Demo_Data.csv'; // Default to demo data
            
            if (userRole === 'admin' || userRole === 'board' || userRole === 'member') {
                // Load real data for authenticated users
                dataFile = 'data/AAAC_Real_Data.csv';
                console.log('Loading real data for authenticated user:', userRole);
            } else {
                // Load demo data for demo users or unauthenticated
                dataFile = 'data/AAAC_Demo_Data.csv';
                console.log('Loading demo data for demo user or unauthenticated');
            }
            
            console.log('Attempting to load data file:', dataFile);
            console.log('Full URL would be:', window.location.origin + window.location.pathname.replace('dashboard.html', '') + dataFile);
            
            fetch(dataFile)
                .then(response => {
                    console.log('=== FETCH RESPONSE ===');
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    console.log('Response url:', response.url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('=== DATA RECEIVED ===');
                    console.log('Data loaded successfully from:', dataFile);
                    console.log('Data length:', data.length);
                    console.log('First 200 characters:', data.substring(0, 200));
                    console.log('Last 200 characters:', data.substring(data.length - 200));
                    
                    if (data.length === 0) {
                        throw new Error('Data file is empty');
                    }
                    
                    const parsedData = parseAccountantData(data);
                    console.log('=== PARSING COMPLETE ===');
                    console.log('Data parsed:', parsedData.length, 'members');
                    
                    if (parsedData.length === 0) {
                        throw new Error('No members parsed from data');
                    }
                    
                    // Use loaded data for display
                    membersData = parsedData;
                    console.log('=== DISPLAYING MEMBERS ===');
                    displayMembers();
                    updateStats();
                    console.log('=== DATA LOAD COMPLETE ===');
                })
                .catch(error => {
                    console.error('=== ERROR IN DATA LOADING ===');
                    console.error('Error loading data:', error);
                    console.error('Error details:', error.message);
                    console.error('Error stack:', error.stack);
                    
                    // Fallback to demo data if real data fails
                    if (dataFile !== 'data/AAAC_Demo_Data.csv') {
                        console.log('Falling back to demo data');
                        loadMembersData(); // This will load demo data
                    } else {
                        console.log('Loading sample data as final fallback');
                        loadSampleData();
                    }
                });
        }

        function loadSampleData() {
            console.log('Loading sample data...');
            membersData = [
                {
                    id: '1',
                    name: 'Demo Member 1',
                    phone: '555-0101',
                    status: 'Active',
                    firstPaymentYear: '2022',
                    registrationFeePaid: '0',
                    registrationFeeAmount: '200',
                    lastPaymentDate: 'AUG 2025',
                    notes: '',
                    '2022': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 15, JUN: 15, JUL: 15, AUG: 15, SEP: 15, OCT: 15, NOV: 15, DEC: 15 },
                    '2023': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 15, JUN: 15, JUL: 15, AUG: 15, SEP: 15, OCT: 15, NOV: 15, DEC: 15 },
                    '2024': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 15, JUN: 15, JUL: 15, AUG: 15, SEP: 15, OCT: 15, NOV: 15, DEC: 15 },
                    '2025': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 15, JUN: 15, JUL: 15, AUG: 15, SEP: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2026': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUN: 0, JUL: 0, AUG: 0, SEP: 0, OCT: 0, NOV: 0, DEC: 0 },
                    incidentals: { 2022: 0, 2023: 0, 2024: 0, 2025: 0, 2026: 0 }
                }
            ];
            displayMembers();
            updateStats();
        }

        function parseContactData(csvText) {
            const lines = csvText.split('\n');
            const contacts = {};
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values[1] && values[1] !== 'Full Name Clean') {
                        contacts[values[0]] = {
                            id: values[0],
                            name: values[1],
                            phone: values[2] || ''
                        };
                    }
                }
            }
            
            return contacts;
        }

        function parseAccountantData(csvText) {
            const lines = csvText.split('\n');
            const members = [];
            
            console.log('Parsing accountant data, total lines:', lines.length);
            
            // Skip header line
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = line.split(',');
                if (columns.length < 10) continue;
                
                const member = {
                    id: columns[0],
                    name: columns[1],
                    phone: columns[2],
                    status: columns[3],
                    firstPaymentYear: columns[4],
                    registrationFeePaid: columns[5],
                    registrationFeeAmount: columns[6],
                    lastPaymentDate: columns[7],
                    notes: columns[8],
                    '2022': {},
                    '2023': {},
                    '2024': {},
                    '2025': {},
                    '2026': {},
                    incidentals: {}
                };
                
                // Parse monthly payments for each year
                const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                
                // 2022 payments (columns 9-20)
                for (let j = 0; j < 12; j++) {
                    const value = parseFloat(columns[9 + j]) || 0;
                    member['2022'][monthNames[j]] = value;
                }
                
                // 2023 payments (columns 21-32)
                for (let j = 0; j < 12; j++) {
                    const value = parseFloat(columns[21 + j]) || 0;
                    member['2023'][monthNames[j]] = value;
                }
                
                // 2024 payments (columns 33-44)
                for (let j = 0; j < 12; j++) {
                    const value = parseFloat(columns[33 + j]) || 0;
                    member['2024'][monthNames[j]] = value;
                }
                
                // 2025 payments (columns 45-56)
                for (let j = 0; j < 12; j++) {
                    const value = parseFloat(columns[45 + j]) || 0;
                    member['2025'][monthNames[j]] = value;
                }
                
                // 2026 payments (columns 57-68)
                for (let j = 0; j < 12; j++) {
                    const value = parseFloat(columns[57 + j]) || 0;
                    member['2026'][monthNames[j]] = value;
                }
                
                // Parse incidentals (columns 69-78)
                for (let j = 0; j < 5; j++) {
                    const year = 2022 + j;
                    const value = parseFloat(columns[69 + j]) || 0;
                    member.incidentals[year] = value;
                }
                
                // Debug for Habtamu
                if (member.id === '1') {
                    console.log('=== HABTAMU PARSED DATA ===');
                    console.log('Member:', member);
                    console.log('2025 payments:', member['2025']);
                }
                
                members.push(member);
            }
            
            console.log('Total members parsed:', members.length);
            return members;
        }

        function addPaymentDataToMembers(csvText, year, allMembers) {
            console.log(`Adding payment data for year ${year}...`);
            const lines = csvText.split('\n');
            console.log(`Year ${year} has ${lines.length} lines`);
            
            // Get the header to determine month column format
            const headerLine = lines[0];
            const headerColumns = headerLine.split(',');
            console.log(`Year ${year} header:`, headerColumns);
            
            // Determine month column mapping based on header
            const monthMapping = {};
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const possibleMonthNames = [
                ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUNE', 'JULY', 'AUG', 'SEPT', 'OCT', 'NOV', 'DEC'], // 2025 format
                ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']  // 2023 format
            ];
            
            // Find which format this CSV uses
            let csvMonthFormat = null;
            for (const format of possibleMonthNames) {
                const foundInHeader = format.every(month => headerColumns.includes(month));
                if (foundInHeader) {
                    csvMonthFormat = format;
                    break;
                }
            }
            
            if (!csvMonthFormat) {
                console.error(`Could not determine month format for year ${year}`);
                return;
            }
            
            console.log(`Year ${year} uses month format:`, csvMonthFormat);
            
            // Create mapping from CSV column index to our month keys
            csvMonthFormat.forEach((csvMonth, index) => {
                const columnIndex = headerColumns.indexOf(csvMonth);
                if (columnIndex !== -1) {
                    monthMapping[columnIndex] = monthNames[index];
                }
            });
            
            console.log(`Year ${year} month mapping:`, monthMapping);
            
            // Skip header line
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = line.split(',');
                if (columns.length < 16) continue;
                
                const memberId = columns[0];
                const name = columns[1];
                const phone = columns[2];
                
                // Skip rows without valid member ID or name
                if (!memberId || !name || memberId === 'Total' || name === 'Total') continue;
                
                // Debug Habtamu specifically
                if (memberId === '1') {
                    console.log(`=== HABTAMU CSV PARSING DEBUG - YEAR ${year} ===`);
                    console.log('Raw line:', line);
                    console.log('Columns:', columns);
                    console.log('Header columns:', headerColumns);
                    console.log('Month mapping:', monthMapping);
                    console.log('Monthly payments:', {
                        JAN: columns[4],
                        FEB: columns[5],
                        MAR: columns[6],
                        APR: columns[7],
                        MAY: columns[8],
                        JUNE: columns[9],
                        JULY: columns[10],
                        AUG: columns[11],
                        SEPT: columns[12],
                        OCT: columns[13],
                        NOV: columns[14],
                        DEC: columns[15]
                    });
                }
                
                // Find the member in our existing members list
                let targetMember = null;
                
                // First try exact ID match
                if (allMembers[memberId]) {
                    targetMember = allMembers[memberId];
                } else {
                    // Try phone number match
                    const cleanPhone = phone.replace(/\D/g, '');
                    for (const existingId in allMembers) {
                        const existingMember = allMembers[existingId];
                        const existingCleanPhone = existingMember.phone.replace(/\D/g, '');
                        if (existingCleanPhone === cleanPhone) {
                            targetMember = existingMember;
                            break;
                        }
                    }
                    
                    // If still no match, try name similarity
                    if (!targetMember) {
                        const cleanName = name.toLowerCase().replace(/[^a-z\s]/g, '').trim();
                        for (const existingId in allMembers) {
                            const existingMember = allMembers[existingId];
                            const existingCleanName = existingMember.name.toLowerCase().replace(/[^a-z\s]/g, '').trim();
                            
                            // Check if names are similar
                            if (existingCleanName.includes(cleanName) || cleanName.includes(existingCleanName) || 
                                existingCleanName.split(' ').some(word => cleanName.includes(word)) ||
                                cleanName.split(' ').some(word => existingCleanName.includes(word))) {
                                targetMember = existingMember;
                                break;
                            }
                        }
                    }
                }
                
                // If we found a matching member, add the payment data
                if (targetMember) {
                    const yearData = targetMember[year.toString()];
                    
                    // Initialize all months to 0
                    monthNames.forEach(month => {
                        yearData[month] = 0;
                    });
                    
                    // Map CSV columns to our month keys using the mapping
                    Object.keys(monthMapping).forEach(csvIndex => {
                        const ourMonth = monthMapping[csvIndex];
                        const paymentAmount = parseFloat(columns[parseInt(csvIndex)]) || 0;
                        yearData[ourMonth] = paymentAmount;
                    });
                    
                    // Handle registration fee if present (usually in REGIST column)
                    if (headerColumns.includes('REGIST') || headerColumns.includes('RegistratioN')) {
                        const registIndex = headerColumns.indexOf('REGIST') !== -1 ? 
                            headerColumns.indexOf('REGIST') : headerColumns.indexOf('RegistratioN');
                        if (registIndex !== -1 && columns[registIndex]) {
                            const registrationFee = parseFloat(columns[registIndex]) || 0;
                            if (registrationFee > 0) {
                                yearData.registration = registrationFee;
                                console.log(`Member ${memberId} paid registration fee $${registrationFee} in ${year}`);
                            }
                        }
                    }
                    
                    // Debug Habtamu's payment data
                    if (memberId === '1') {
                        console.log(`Added Habtamu ${year} payments:`, yearData);
                        console.log(`Total for ${year}:`, Object.values(yearData).reduce((sum, val) => sum + val, 0));
                    }
                } else {
                    console.log(`No matching member found for payment data: ID ${memberId}, Name ${name}`);
                }
            }
            
            console.log(`Year ${year} payment data processed`);
        }

        function loadSampleData(contactData = {}) {
            // Sample data for demonstration
            membersData = [
                {
                    id: 1,
                    name: contactData[1]?.name || "HABTAMU BAKANA",
                    phone: contactData[1]?.phone || "7734941942",
                    registration: 0,
                    '2022': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2023': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2024': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2025': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2026': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2027': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 }
                },
                {
                    id: 24,
                    name: contactData[24]?.name || "BIRUK TITO EYESUE",
                    phone: contactData[24]?.phone || "7736540023",
                    registration: 200,
                    '2022': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2023': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2024': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2025': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2026': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2027': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 }
                },
                {
                    id: 56,
                    name: contactData[56]?.name || "RICHARED BIRHANU",
                    phone: contactData[56]?.phone || "7734945767",
                    registration: 200,
                    '2022': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2023': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2024': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2025': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2026': { JAN: 15, FEB: 15, MAR: 15, APR: 15, MAY: 15, JUNE: 16, JULY: 15, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 },
                    '2027': { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 }
                }
            ];
        }

        function calculateDetailedBalance(member) {
            // Debug for Habtamu
            if (member.id === '1') {
                console.log('=== HABTAMU BALANCE CALCULATION ===');
                console.log('Member data:', member);
                console.log('2025 payments:', member['2025']);
                console.log('2026 payments:', member['2026']);
            }
            
            // Use the fixed current date (August 2025)
            const currentYear = CURRENT_YEAR; // 2025
            const currentMonth = CURRENT_MONTH; // 7 (August)
            
            let totalPaid = 0;
            let totalRegistrationPaid = 0;
            let totalIncidentals = 0;
            let firstPaymentYear = null;
            let firstPaymentMonth = null;
            let lastPaidMonth = null;
            let lastPaidYear = null;
            let monthsBehind = 0;
            let isActiveMember = false;
            
            // Calculate across all years
            const years = ['2022', '2023', '2024', '2025', '2026', '2027'];
            
            // First pass: calculate total paid, find first and last payment
            years.forEach(year => {
                const yearData = member[year] || {};
                const yearNum = parseInt(year);
                
                MONTHS.forEach((month, monthIndex) => {
                    const monthPayment = yearData[month] || 0;
                    totalPaid += monthPayment;
                    
                    // Track the first month they paid
                    if (monthPayment > 0 && firstPaymentYear === null) {
                        firstPaymentYear = year;
                        firstPaymentMonth = month;
                    }
                    
                    // Track the last month they paid
                    if (monthPayment > 0) {
                        lastPaidMonth = month;
                        lastPaidYear = year;
                    }
                });
                
                // Add incidentals to total paid
                if (yearData.incidentals) {
                    yearData.incidentals.forEach(incidental => {
                        totalIncidentals += incidental.amount;
                        totalPaid += incidental.amount;
                    });
                }
            });
            
            // Determine if member is active (has paid recently and hasn't been inactive for too long)
            // A member is active if they have any payments and their last payment is recent (since mid-2022)
            // AND they haven't been inactive for 36+ months
            const hasAnyPayments = totalPaid > 0;
            const lastPaymentYear = lastPaidYear ? parseInt(lastPaidYear) : 0;
            const lastPaymentMonth = lastPaidMonth ? MONTHS.indexOf(lastPaidMonth) : -1;
            
            // Check if last payment was since mid-2022 (July 2022 or later)
            let isRecentPayment = false;
            if (lastPaymentYear > 2022) {
                isRecentPayment = true; // Any payment in 2023 or later
            } else if (lastPaymentYear === 2022 && lastPaymentMonth >= 6) { // July = index 6
                isRecentPayment = true; // Payment in July 2022 or later
            }
            
            // Calculate months since last payment
            let monthsSinceLastPayment = 0;
            if (lastPaymentYear && lastPaymentMonth !== -1) {
                const lastPaidYearNum = parseInt(lastPaymentYear);
                if (lastPaidYearNum < currentYear) {
                    // Last payment was in a previous year
                    monthsSinceLastPayment = (currentYear - lastPaidYearNum - 1) * 12 + (12 - lastPaymentMonth - 1) + (currentMonth + 1);
                } else if (lastPaidYearNum === currentYear) {
                    // Last payment was in current year
                    monthsSinceLastPayment = currentMonth - lastPaymentMonth;
                } else {
                    // Last payment was in future year
                    monthsSinceLastPayment = 0;
                }
            }
            
            // Check if they've been inactive for 36+ months
            const isTooLongInactive = monthsSinceLastPayment >= 36;
            
            isActiveMember = hasAnyPayments && isRecentPayment && !isTooLongInactive;
            
            // Debug for Habtamu
            if (member.id === '1') {
                console.log('=== HABTAMU ACTIVE STATUS DEBUG ===');
                console.log('First payment year:', firstPaymentYear);
                console.log('First payment month:', firstPaymentMonth);
                console.log('Last payment year:', lastPaidYear);
                console.log('Last payment month:', lastPaidMonth);
                console.log('Total paid:', totalPaid);
                console.log('Has any payments:', hasAnyPayments);
                console.log('Last payment year:', lastPaymentYear);
                console.log('Last payment month index:', lastPaymentMonth);
                console.log('Months since last payment:', monthsSinceLastPayment);
                console.log('Is recent payment (since mid-2022):', isRecentPayment);
                console.log('Is too long inactive (36+ months):', isTooLongInactive);
                console.log('Is active member:', isActiveMember);
                console.log('Payment data by year:');
                years.forEach(year => {
                    const yearData = member[year] || {};
                    const yearTotal = Object.values(yearData).reduce((sum, val) => sum + (val || 0), 0);
                    console.log(`  ${year}: $${yearTotal}`, yearData);
                });
                console.log('=== END HABTAMU DEBUG ===');
            }
            
            // If not an active member, return early with inactive status
            if (!isActiveMember) {
                            return {
                currentBalance: 0,
                totalDue: 0,
                totalPaid: totalPaid,
                totalRegistrationPaid: totalRegistrationPaid,
                totalIncidentals: totalIncidentals,
                paidUpTo: 'Inactive Member',
                balanceDetails: 'No recent payments or inactive 36+ months',
                status: 'inactive',
                statusText: 'üö´ Inactive',
                monthsBehind: 0,
                firstPaymentMonth: firstPaymentMonth,
                firstPaymentYear: firstPaymentYear,
                lastPaidMonth: lastPaidMonth,
                lastPaidYear: lastPaidYear,
                isActiveMember: false
            };
            }
            
            // Calculate what's due from their first payment to current date
            let totalDue = 0;
            let paidUpTo = 'Not Started';
            
            if (firstPaymentYear && firstPaymentMonth) {
                const firstMonthIndex = MONTHS.indexOf(firstPaymentMonth);
                const firstYearNum = parseInt(firstPaymentYear);
                
                // Calculate what they should have paid from first payment to current date
                // This is the total amount they should have paid, not what they owe
                for (let year = firstYearNum; year <= currentYear; year++) {
                    const startMonth = year === firstYearNum ? firstMonthIndex : 0;
                    const endMonth = year === currentYear ? currentMonth : 11;
                    
                    for (let month = startMonth; month <= endMonth; month++) {
                        totalDue += MONTHLY_FEE;
                    }
                }
                
                // Determine what month they're paid up to
                if (lastPaidYear && lastPaidMonth) {
                    const monthIndex = MONTHS.indexOf(lastPaidMonth);
                    paidUpTo = `${MONTH_NAMES[monthIndex]} ${lastPaidYear}`;
                }
                
                // Calculate months behind from last payment to current date
                if (lastPaidYear && lastPaidMonth) {
                    const lastPaidMonthIndex = MONTHS.indexOf(lastPaidMonth);
                    const lastPaidYearNum = parseInt(lastPaidYear);
                    
                    if (lastPaidYearNum < currentYear) {
                        // Last payment was in a previous year
                        monthsBehind = (currentYear - lastPaidYearNum - 1) * 12 + (12 - lastPaidMonthIndex - 1) + (currentMonth + 1);
                    } else if (lastPaidYearNum === currentYear) {
                        // Last payment was in current year
                        if (lastPaidMonthIndex < currentMonth) {
                            monthsBehind = currentMonth - lastPaidMonthIndex;
                        } else {
                            monthsBehind = 0; // They're paid ahead
                        }
                    } else {
                        // Last payment was in future year
                        monthsBehind = 0; // They're paid ahead
                    }
                }
            } else {
                // No payments at all - count from 2023 to current
                totalDue = (currentYear - 2023) * 12 + currentMonth + 1;
                monthsBehind = totalDue / MONTHLY_FEE;
            }
            
            // Debug for Habtamu
            if (member.id === '1') {
                console.log('Total paid:', totalPaid);
                console.log('Total due:', totalDue);
                console.log('First payment:', firstPaymentMonth, firstPaymentYear);
                console.log('Last paid month:', lastPaidMonth);
                console.log('Last paid year:', lastPaidYear);
                console.log('Months behind:', monthsBehind);
                console.log('Paid up to:', paidUpTo);
                console.log('Is active member:', isActiveMember);
            }
            
            // Calculate registration fee based on when they started
            if (firstPaymentYear) {
                const startYear = parseInt(firstPaymentYear);
                if (startYear >= 2023) {
                    totalRegistrationPaid = NEW_REGISTRATION_FEE;
                } else {
                    totalRegistrationPaid = OLD_REGISTRATION_FEE;
                }
            }
            
            // Calculate current balance
            const currentBalance = totalPaid - totalDue;
            let balanceDetails = '';
            
            if (currentBalance > 0) {
                balanceDetails = `Paid ahead by $${currentBalance}`;
            } else if (currentBalance < 0) {
                balanceDetails = `Owes $${Math.abs(currentBalance)} (${monthsBehind} months behind)`;
            } else {
                balanceDetails = 'Up to date';
            }
            
            // Add incidentals info if any
            if (totalIncidentals > 0) {
                balanceDetails += ` | Incidentals: $${totalIncidentals}`;
            }
            
            // Debug for Habtamu
            if (member.id === '1') {
                console.log('Current balance:', currentBalance);
                console.log('Balance details:', balanceDetails);
                console.log('=== END HABTAMU CALCULATION ===');
            }
            
            // Determine membership status
            let status = 'current';
            let statusText = '‚úÖ Current';
            
            if (monthsBehind >= 24) { // Over 2 years behind
                status = 'risk-of-removal';
                statusText = 'üö® Risk of Removal';
            } else if (monthsBehind >= 12) { // 1-2 years behind
                status = 'issue';
                statusText = '‚ö†Ô∏è Issue';
            } else if (monthsBehind >= 3) { // 3 months - 1 year behind
                status = 'risk';
                statusText = '‚ùå Risk';
            } else if (monthsBehind > 0) { // 1-3 months behind
                status = 'current';
                statusText = '‚úÖ Current';
            } else { // Up to date or paid ahead
                status = 'current';
                statusText = '‚úÖ Current';
            }
            
            return {
                currentBalance: currentBalance,
                totalDue: totalDue,
                totalPaid: totalPaid,
                totalRegistrationPaid: totalRegistrationPaid,
                totalIncidentals: totalIncidentals,
                paidUpTo: paidUpTo,
                balanceDetails: balanceDetails,
                status: status,
                statusText: statusText,
                monthsBehind: monthsBehind,
                firstPaymentMonth: firstPaymentMonth,
                firstPaymentYear: firstPaymentYear,
                lastPaidMonth: lastPaidMonth,
                lastPaidYear: lastPaidYear,
                isActiveMember: true
            };
        }

        function displayMembers(data = window.membersData || membersData) {
            console.log('=== DISPLAY MEMBERS DEBUG ===');
            console.log('Data parameter:', data);
            console.log('window.membersData:', window.membersData);
            console.log('local membersData:', membersData);
            console.log('Total members data:', data.length);
            console.log('Sample member data:', data[0]);
            
            const container = document.getElementById('members-container');
            const activeMembers = data.filter(member => {
                const balanceInfo = calculateDetailedBalance(member);
                console.log(`Member ${member.id} (${member.name}): isActiveMember = ${balanceInfo.isActiveMember}`);
                return balanceInfo.isActiveMember;
            });
            
            const inactiveMembers = data.filter(member => {
                const balanceInfo = calculateDetailedBalance(member);
                return !balanceInfo.isActiveMember;
            });
            
            console.log(`Active members: ${activeMembers.length}, Inactive members: ${inactiveMembers.length}`);
            
            // If no active members, show all members for debugging
            if (activeMembers.length === 0) {
                console.log('No active members found, showing all members for debugging');
                let html = `
                    <div class="members-section">
                        <h3>All Members (${data.length}) - Debug Mode</h3>
                        <div class="members-grid">
                `;
                
                data.forEach(member => {
                    const balanceInfo = calculateDetailedBalance(member);
                    const balanceClass = balanceInfo.currentBalance >= 0 ? 'positive' : 'negative';
                    
                    html += `
                        <div class="member-card">
                            <div class="member-header">
                                <span class="member-id">${member.id}</span>
                                <span class="member-status ${balanceInfo.status}">${balanceInfo.statusText}</span>
                            </div>
                                                    <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-id">ID: ${member.id}</div>
                        </div>
                        <div class="member-balance">
                            <div class="balance-amount ${balanceClass}">$${balanceInfo.currentBalance}</div>
                            <div class="balance-details">${balanceInfo.balanceDetails}</div>
                            <div class="paid-up-to">Paid up to: ${balanceInfo.paidUpTo}</div>
                            <div class="debug-info">First payment: ${balanceInfo.firstPaymentYear || 'None'}, Active: ${balanceInfo.isActiveMember}</div>
                        </div>
                            <div class="member-actions">
                                <button onclick="recordPaymentForMember('${member.name}')" class="btn-record">Record Payment</button>
                                <button onclick="sendReminder('${member.name}', ${balanceInfo.currentBalance})" class="btn-reminder" title="Copy message for Telegram/Viber/WhatsApp">Copy Message</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                return;
            }
            
            let html = `
                <div class="members-section">
                    <h3>Active Members (${activeMembers.length})</h3>
                    <div class="members-grid">
            `;
            
            activeMembers.forEach(member => {
                const balanceInfo = calculateDetailedBalance(member);
                const balanceClass = balanceInfo.currentBalance >= 0 ? 'positive' : 'negative';
                
                html += `
                    <div class="member-card">
                        <div class="member-header">
                            <span class="member-id">${member.id}</span>
                            <span class="member-status ${balanceInfo.status}">${balanceInfo.statusText}</span>
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-id">ID: ${member.id}</div>
                        </div>
                        <div class="member-balance">
                            <div class="balance-amount ${balanceClass}">$${balanceInfo.currentBalance}</div>
                            <div class="balance-details">${balanceInfo.balanceDetails}</div>
                            <div class="paid-up-to">Paid up to: ${balanceInfo.paidUpTo}</div>
                        </div>
                        <div class="member-actions">
                            <button onclick="recordPaymentForMember('${member.name}')" class="btn-record">Record Payment</button>
                                                            <button onclick="sendReminder('${member.name}', ${balanceInfo.currentBalance})" class="btn-reminder" title="Copy message for Telegram/Viber/WhatsApp">Copy Message</button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Add inactive members section
            if (inactiveMembers.length > 0) {
                html += `
                    <div class="members-section inactive-section">
                        <h3>Inactive Members (${inactiveMembers.length}) - No recent payments or inactive 36+ months</h3>
                        <div class="members-grid">
                `;
                
                inactiveMembers.forEach(member => {
                    const balanceInfo = calculateDetailedBalance(member);
                    
                    html += `
                        <div class="member-card inactive">
                            <div class="member-header">
                                <span class="member-id">${member.id}</span>
                                <span class="member-status inactive">üö´ Inactive</span>
                            </div>
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                                <div class="member-id">ID: ${member.id}</div>
                            </div>
                            <div class="member-balance">
                                <div class="balance-details">No recent payments or inactive 36+ months</div>
                                <div class="paid-up-to">Last payment: ${balanceInfo.lastPaidYear || 'Never'}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function updateStats() {
            const dataToUse = window.membersData || membersData;
            const activeMembers = dataToUse.filter(member => {
                const balanceInfo = calculateDetailedBalance(member);
                return balanceInfo.isActiveMember;
            });
            
            const inactiveMembers = dataToUse.filter(member => {
                const balanceInfo = calculateDetailedBalance(member);
                return !balanceInfo.isActiveMember;
            });
            
            let currentCount = 0;
            let issueCount = 0;
            let riskCount = 0;
            let riskOfRemovalCount = 0;
            let totalBalance = 0;
            
            activeMembers.forEach(member => {
                const balanceInfo = calculateDetailedBalance(member);
                // Only add negative balances (what they owe) to the total
                if (balanceInfo.currentBalance < 0) {
                    totalBalance += Math.abs(balanceInfo.currentBalance);
                }
                
                switch (balanceInfo.status) {
                    case 'current':
                        currentCount++;
                        break;
                    case 'issue':
                        issueCount++;
                        break;
                    case 'risk':
                        riskCount++;
                        break;
                    case 'risk-of-removal':
                        riskOfRemovalCount++;
                        break;
                }
            });
            
            document.getElementById('total-members').textContent = activeMembers.length;
            document.getElementById('current-members').textContent = currentCount;
            document.getElementById('issue-members').textContent = issueCount;
            document.getElementById('risk-members').textContent = riskCount;
            document.getElementById('risk-of-removal-members').textContent = riskOfRemovalCount;
            document.getElementById('total-balance').textContent = `$${totalBalance.toFixed(2)} (Total Owed)`;
            document.getElementById('inactive-members').textContent = inactiveMembers.length;
        }

        function filterByStatus(status) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (status === 'all') {
                displayMembers();
                return;
            }
            
            const dataToUse = window.membersData || membersData;
            const filteredData = dataToUse.filter(member => {
                const balanceInfo = calculateDetailedBalance(member);
                return balanceInfo.status === status;
            });
            
            displayMembers(filteredData);
        }

        function searchMembers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dataToUse = window.membersData || membersData;
            const filteredData = dataToUse.filter(member => 
                member.name.toLowerCase().includes(searchTerm) ||
                member.phone.includes(searchTerm) ||
                member.id.toString().includes(searchTerm)
            );
            displayMembers(filteredData);
        }

        function recordPaymentForMember(memberName) {
            document.getElementById('memberName').value = memberName;
            document.getElementById('paymentModal').style.display = 'block';
        }

        function recordPayment() {
            const memberName = document.getElementById('memberName').value;
            const paymentYear = document.getElementById('paymentYear').value;
            const paymentType = document.getElementById('paymentType').value;
            const paymentMonth = document.getElementById('paymentMonth').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentNotes = document.getElementById('paymentNotes').value;

            // Find the member and update their payment
            const dataToUse = window.membersData || membersData;
            const member = dataToUse.find(m => m.name === memberName);
            if (member) {
                if (!member[paymentYear]) {
                    member[paymentYear] = { JAN: 0, FEB: 0, MAR: 0, APR: 0, MAY: 0, JUNE: 0, JULY: 0, AUG: 0, SEPT: 0, OCT: 0, NOV: 0, DEC: 0 };
                }
                
                if (paymentType === 'incidental') {
                    // For incidentals, add to a special field
                    if (!member[paymentYear].incidentals) {
                        member[paymentYear].incidentals = [];
                    }
                    member[paymentYear].incidentals.push({
                        amount: paymentAmount,
                        month: paymentMonth,
                        notes: paymentNotes,
                        date: new Date().toISOString()
                    });
                } else {
                    // For regular monthly payments
                    member[paymentYear][paymentMonth] = (member[paymentYear][paymentMonth] || 0) + paymentAmount;
                }
                
                console.log(`Payment recorded: ${memberName} - ${paymentMonth} ${paymentYear} - $${paymentAmount}`);
                
                // Update display
                displayMembers();
                updateStats();
                closeModal();
                
                alert(`Payment of $${paymentAmount} recorded for ${memberName} (${paymentMonth} ${paymentYear})`);
            }
        }

        function sendReminder(memberName, balance) {
            let message, messageType;
            
            if (balance >= 0) {
                // They have paid ahead or are current - send thank you message
                messageType = "Receipt";
                message = `·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·ä≠·çç·ã´ ·ã∞·à®·à∞·äù

·ãç·ãµ ${memberName}

·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·ä†·â£·àç·äê·âµ·ãé ·ä≠·çç·ã´ ·â†·àò·çà·å∏·àù·ãé ·ä†·àò·à∞·åç·äì·àà·àÅ·ç¢

·ã®·ä†·â£·àç·äê·âµ·ãé ·àÇ·à≥·â• ·ã®·â∞·àü·àã ·äê·ãç·ç¢ ·ã®·âÄ·à™ ·àÇ·à≥·â•·ãé $${balance} ·äê·ãç·ç¢

üìã ·ã®·ä≠·çç·ã´ ·ã∞·à®·à∞·äù:
‚Ä¢ ·ä†·â£·àç: ${memberName}
‚Ä¢ ·ã®·âÄ·à™ ·àÇ·à≥·â•: $${balance}
‚Ä¢ ·âÄ·äï: ${new Date().toLocaleDateString()}
‚Ä¢ ·ã®·ä≠·çç·ã´ ·ãò·ã¥: Zelle (aaaichicago@gmail.com)

·ä®·àù·àµ·åã·äì ·åã·à≠
·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·â¶·à≠·ãµ`;
            } else {
                // They owe money - send payment reminder
                messageType = "Payment Reminder";
                message = `·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·ä≠·çç·ã´ ·àõ·àµ·â≥·ãà·àª

·ãç·ãµ ${memberName}

·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé  ·ä†·â£·àç·äê·âµ·ãé ·âÄ·à™ ·àÇ·à≥·â• $${Math.abs(balance)} ·äê·ãç·ç¢

·ä≠·çç·ã´·ãç·äï ·â† Zelle  ·àà·àò·àã·ä≠: aaaichicago@gmail.com ·ã≠·å†·âÄ·àô·äì ·àí·à≥·â¶·âµ·äï ·ã≠·ä®·çç·àâ ·ãò·äï·ãµ ·â†·âµ·àï·âµ·äì ·ä•·äï·å†·ã≠·âÉ·àà·äï·ç¢

·ä®·àù·àµ·åã·äì ·åã·à≠
·ã®·ä†·ã≤·àµ ·ä†·â†·â£ ·àõ·àï·â†·à≠ ·â†·â∫·ä´·åé ·â¶·à≠·ãµ`;
            }
            
            // Copy message to clipboard
            navigator.clipboard.writeText(message).then(() => {
                alert(`‚úÖ ${messageType} message copied to clipboard!\n\nüì± You can now paste this message into:\n‚Ä¢ Telegram\n‚Ä¢ Viber\n‚Ä¢ WhatsApp\n‚Ä¢ SMS\n‚Ä¢ Email\n\nüí° Tip: The message is ready to send - just paste it in your preferred messaging app!`);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`‚úÖ ${messageType} message copied to clipboard!\n\nüì± You can now paste this message into:\n‚Ä¢ Telegram\n‚Ä¢ Viber\n‚Ä¢ WhatsApp\n‚Ä¢ SMS\n‚Ä¢ Email\n\nüí° Tip: The message is ready to send - just paste it in your preferred messaging app!`);
            });
            
            console.log(`${messageType} message prepared for ${memberName}: ${message}`);
        }

        function exportData() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AAAC_Membership_Status_${currentYear}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function generateCSV() {
            const headers = ['ID', 'NAME', 'PHONE', 'REGISTRATION', 'STATUS', 'BALANCE', 'PAID_UP_TO', 'MONTHS_BEHIND'];
            const rows = [headers];
            
            const dataToUse = window.membersData || membersData;
            dataToUse.forEach(member => {
                const balanceInfo = calculateDetailedBalance(member);
                rows.push([
                    member.id,
                    member.name,
                    member.phone,
                    member.registration,
                    balanceInfo.statusText,
                    balanceInfo.currentBalance,
                    balanceInfo.paidUpTo,
                    balanceInfo.monthsBehind
                ]);
            });
            
            return rows.map(row => row.join(',')).join('\n');
        }

        function closeModal() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('memberDetailsModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
